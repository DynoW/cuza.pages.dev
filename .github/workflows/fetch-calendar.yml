name: Fetch BAC Calendar

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fetch-and-parse:
    runs-on: ubuntu-latest
    steps:
      # - name: Checkout repo
      #   uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pdfminer.six

      - name: Download BAC calendar PDF
        run: |
          mkdir -p tmp
          curl -L --fail --retry 3 --retry-delay 2 \
          -o tmp/Calendar_bacalaureat_2025.pdf \
          "https://bacalaureat.edu.ro/Info/Calendar_bacalaureat_2025.pdf"

      - name: Convert PDF to text
        run: |
          set -e
          python - <<'PY'
          import sys
          from pdfminer.high_level import extract_text

          pdf_path = 'tmp/Calendar_bacalaureat_2025.pdf'
          txt_path = 'tmp/Calendar_bacalaureat_2025.txt'

          text = extract_text(pdf_path) or ''
          with open(txt_path, 'w', encoding='utf-8') as f:
            f.write(text)
          print(f"Wrote {txt_path} via pdfminer, {len(text.encode('utf-8'))} bytes")
          PY
          test -s tmp/Calendar_bacalaureat_2025.txt || { echo "Empty text"; exit 1; }
          echo "--- Begin extracted text preview ---"
          sed -n '1,120p' tmp/Calendar_bacalaureat_2025.txt | sed 's/\t/ /g'
          echo "--- End extracted text preview ---"

      - name: Parse text and produce JSON
        run: |
          node - <<'NODE'
          const fs = require('fs');

          const inPath = 'tmp/Calendar_bacalaureat_2025.txt';
          const outDir = 'public/assets/data';
          const outPath = `${outDir}/bac-calendar-2025.json`;

          const months = {
          'ianuarie': '01', 'februarie': '02', 'martie': '03', 'aprilie': '04', 'mai': '05',
          'iunie': '06', 'iulie': '07', 'august': '08', 'septembrie': '09', 'octombrie': '10',
          'noiembrie': '11', 'decembrie': '12'
          };

          const raw = fs.readFileSync(inPath, 'utf8');
          // Normalize dashes and whitespace for robust regex matching
          const text = raw
          .replace(/\r/g, '')
          .replace(/[—–‑]/g, '-') // unify em/en/nb dashes to '-'
          .replace(/\u00a0/g, ' ') // non-breaking space
          .replace(/[\t]+/g, ' ')
          .replace(/[ ]{2,}/g, ' ');

          function sliceBetween(src, startRe, endRe) {
          const s = src.search(startRe);
          if (s === -1) return '';
          const rest = src.slice(s);
          const eIdx = rest.search(endRe);
          if (eIdx === -1) return rest;
          return rest.slice(0, eIdx);
          }

          function extractSession(block, sessionName) {
          // Allow matches even if the "E.a)" part is on the next line or has spaces like "E. a)"
          const re = /(\d{1,2})\s+(ianuarie|februarie|martie|aprilie|mai|iunie|iulie|august|septembrie|octombrie|noiembrie|decembrie)\s+(\d{4})[\s\S]{0,200}?E\s*\.\s*(a|b|c|d)\)?/gmi;
          const dates = {};
          let m;
          while ((m = re.exec(block)) !== null) {
          const day = String(parseInt(m[1], 10)).padStart(2, '0');
          const monthNum = months[m[2].toLowerCase()];
          const year = m[3];
          const code = m[4].toLowerCase();
          if (code === 'a' || code === 'c' || code === 'd') {
          const iso = `${year}-${monthNum}-${day}`;
          dates[`E.${code}`] = iso;
          }
          }
          return { session: sessionName, dates };
          }

          // Find session blocks
          const juneBlock = sliceBetween(text, /Sesiunea\s+iunie\s+2025/i, /Sesiunea\s+iulie/i);
          const julAugBlock = sliceBetween(text, /Sesiunea\s+iulie[^\n]*2025/i, /(ANEXA|NOTA|CALENDARUL\s+privind|$)/i);

          const result = {
          year: 2025,
          sessions: [
          extractSession(juneBlock, 'iunie'),
          extractSession(julAugBlock, 'iulie-august')
          ]
          };

          fs.mkdirSync(outDir, { recursive: true });
          fs.writeFileSync(outPath, JSON.stringify(result, null, 2), 'utf8');
          console.log('Parsed sessions:');
          for (const s of result.sessions) {
            console.log(`- ${s.session}:`, s.dates);
          }
          console.log(`Wrote ${outPath}`);
          NODE

      - name: Upload calendar JSON artifact
        uses: actions/upload-artifact@v4
        with:
          name: bac-calendar-2025
          path: public/assets/data/bac-calendar-2025.json
          if-no-files-found: error
          retention-days: 7

      # - name: Commit and push JSON
      #   env:
      #     GIT_AUTHOR_NAME: github-actions[bot]
      #     GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      #     GIT_COMMITTER_NAME: github-actions[bot]
      #     GIT_COMMITTER_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
      #   run: |
      #     if git diff --quiet -- public/assets/data/bac-calendar-2025.json; then
      #       echo "No changes to commit."
      #       exit 0
      #     fi
      #     git add public/assets/data/bac-calendar-2025.json
      #     git commit -m "chore(data): update BAC 2025 calendar E.a/E.c/E.d dates from official PDF"
      #     git push
