---
import { getCountdownConfig } from "../config/countdown";

const config = getCountdownConfig();
---

<div
  id="countdown-container"
  class="bg-zinc-950/90 rounded-3xl py-3 px-4 text-white"
>
  <div class="flex justify-between items-center">
    <h3 id="countdown-title" class="text-lg font-bold">{config.title}</h3>
    <button id="toggle-countdown" class="text-white hover:text-gray-300">
      <span id="toggle-icon" class="cursor-pointer">▼</span>
    </button>
  </div>

  <div id="countdown-content">
    <!-- Countdown timer until exam -->
    <div id="countdown-to-exam">
      <p class="text-sm mb-1 mt-1">Timp rămas până la examen:</p>
      <div class="grid grid-cols-4 gap-2 text-center text-lg md:text-xl font-bold">
        <div class="bg-neutral-800/90 rounded-lg p-1 flex-1 min-w-0">
          <span id="days">--</span>
          <span class="text-xs block text-center">Zile</span>
        </div>
        <div class="bg-neutral-800/90 rounded-lg p-1 flex-1 min-w-0">
          <span id="hours">--</span>
          <span class="text-xs block text-center">Ore</span>
        </div>
        <div class="bg-neutral-800/90 rounded-lg p-1 flex-1 min-w-0">
          <span id="minutes">--</span>
          <span class="text-xs block text-center">Min</span>
        </div>
        <div class="bg-neutral-800/90 rounded-lg p-1 flex-1 min-w-0">
          <span id="seconds">--</span>
          <span class="text-xs block text-center">Sec</span>
        </div>
      </div>
    </div>

    <!-- Progress bar until results -->
    <div id="progress-to-results" class="hidden">
      <div class="w-full bg-[rgba(30,33,36,.9)] rounded-full h-5 mb-2">
        <div
          id="progress-bar"
          class="bg-blue-600 h-5 rounded-full text-xs text-center leading-5 text-white transition-all duration-300"
          style="width: 0%"
        >
        </div>
      </div>
    </div>

    <!-- Completion message -->
    <div id="completion-message" class="hidden">
      <div class="w-full bg-[rgba(30,33,36,.9)] rounded-full h-5 mb-2">
        <div class="bg-green-600 h-5 rounded-full text-xs text-center leading-5 text-white w-full">
          Completed
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // --- time utils ---
  interface TimeDifference { days: number; hours: number; minutes: number; seconds: number; }
  const calculateTimeDifference = (targetTime: number, currentTime: number = Date.now()): TimeDifference => {
    const distance = targetTime - currentTime;
    if (distance <= 0) return { days: 0, hours: 0, minutes: 0, seconds: 0 };
    return {
      days: Math.floor(distance / (1000 * 60 * 60 * 24)),
      hours: Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)),
      minutes: Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60)),
      seconds: Math.floor((distance % (1000 * 60)) / 1000),
    };
  };
  const calculateProgress = (startTime: number, endTime: number, currentTime: number = Date.now()): number => {
    if (currentTime <= startTime) return 0;
    if (currentTime >= endTime) return 100;
    return Math.round(((currentTime - startTime) / (endTime - startTime)) * 100);
  };

  // --- dom utils ---
  const getElementById = (id: string): HTMLElement | null => document.getElementById(id);
  const setElementContent = (element: HTMLElement | null, content: string): void => { if (element) element.textContent = content; };
  const showElement = (element: HTMLElement | null): void => { if (element) { element.classList.remove('hidden'); element.style.display = ''; } };
  const hideElement = (element: HTMLElement | null): void => { if (element) { element.classList.add('hidden'); element.style.display = 'none'; } };
  const padNumber = (num: number): string => num < 10 ? `0${num}` : num.toString();

  // --- storage utils ---
  const getStorageItem = (key: string, defaultValue: string = ''): string => {
    if (typeof localStorage === 'undefined') return defaultValue;
    return localStorage.getItem(key) || defaultValue;
  };
  const setStorageItem = (key: string, value: string): void => {
    if (typeof localStorage !== 'undefined') localStorage.setItem(key, value);
  };

  class CountdownManager {
    private startDate: number;
    private endDate: number;
    private elements: Record<string, HTMLElement | null>;
    // Store DOM interval ID as a number to match clearInterval signature
    private updateInterval: number | null = null;
    private config: { title: string; startDate: string; endDate: string };

    constructor(config: { title: string; startDate: string; endDate: string }) {
      this.config = config;
      this.startDate = new Date(config.startDate).getTime();
      this.endDate = new Date(config.endDate).getTime();

      this.elements = {
        days: getElementById("days"),
        hours: getElementById("hours"),
        minutes: getElementById("minutes"),
        seconds: getElementById("seconds"),
        title: getElementById("countdown-title"),
        countdownToExam: getElementById("countdown-to-exam"),
        progressToResults: getElementById("progress-to-results"),
        completionMessage: getElementById("completion-message"),
        progressBar: getElementById("progress-bar"),
        toggleButton: getElementById("toggle-countdown"),
        toggleIcon: getElementById("toggle-icon"),
        countdownContent: getElementById("countdown-content"),
      };

      this.init();
    }

    private init(): void {
      this.setupToggle();
      this.startUpdating();
    }

    private setupToggle(): void {
      const { toggleButton, countdownContent, toggleIcon } = this.elements;
      if (!toggleButton || !countdownContent || !toggleIcon) return;

      const isCollapsed = getStorageItem("countdownCollapsed") === "true";
      this.setCollapseState(isCollapsed);

      toggleButton.addEventListener("click", () => {
        const isCurrentlyVisible = countdownContent.style.display !== "none";
        this.setCollapseState(isCurrentlyVisible);
        setStorageItem("countdownCollapsed", isCurrentlyVisible.toString());
      });
    }

    private setCollapseState(collapsed: boolean): void {
      const { countdownContent, toggleIcon } = this.elements;
      if (!countdownContent || !toggleIcon) return;

      countdownContent.style.display = collapsed ? "none" : "block";
      toggleIcon.textContent = collapsed ? "▲" : "▼";
    }

    private startUpdating(): void {
      this.updateCountdown();
      // Use window.setInterval to ensure DOM typing (number)
      this.updateInterval = window.setInterval(() => this.updateCountdown(), 1000);
    }

    private updateCountdown(): void {
      const now = Date.now();
      const distanceToExam = this.startDate - now;

      if (distanceToExam > 0) {
        this.showCountdownToExam();
      } else {
        const distanceToResults = this.endDate - now;
        if (distanceToResults > 0) {
          this.showProgressToResults();
        } else {
          this.showCompletionMessage();
        }
      }
    }

    private showCountdownToExam(): void {
      showElement(this.elements.countdownToExam);
      hideElement(this.elements.progressToResults);
      hideElement(this.elements.completionMessage);

      if (this.elements.title) {
        setElementContent(this.elements.title, this.config.title);
      }

      const time = calculateTimeDifference(this.startDate);
      setElementContent(this.elements.days, time.days.toString());
      setElementContent(this.elements.hours, padNumber(time.hours));
      setElementContent(this.elements.minutes, padNumber(time.minutes));
      setElementContent(this.elements.seconds, padNumber(time.seconds));
    }

    private showProgressToResults(): void {
      hideElement(this.elements.countdownToExam);
      showElement(this.elements.progressToResults);
      hideElement(this.elements.completionMessage);

      if (this.elements.title) {
        setElementContent(this.elements.title, this.config.title);
      }

      const progress = calculateProgress(this.startDate, this.endDate);
      if (this.elements.progressBar) {
        this.elements.progressBar.style.width = `${progress}%`;
        setElementContent(this.elements.progressBar, `${progress}%`);
      }
    }

    private showCompletionMessage(): void {
      hideElement(this.elements.countdownToExam);
      hideElement(this.elements.progressToResults);
      showElement(this.elements.completionMessage);
      setElementContent(this.elements.title, `${this.config.title} | Finalizat`);
    }

    public destroy(): void {
      if (this.updateInterval !== null) {
        // Use window.clearInterval to match number ID
        window.clearInterval(this.updateInterval);
        this.updateInterval = null;
      }
    }
  }

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    const configScript = document.querySelector(
      "script[data-countdown-config]"
    );
    if (configScript) {
      const config = JSON.parse(configScript.textContent || "{}");
      new CountdownManager(config);
    }
  });
</script>

<script is:inline define:vars={{ config }}>
  // Pass config to the main script
  const scriptEl = document.createElement("script");
  scriptEl.type = "application/json";
  scriptEl.dataset.countdownConfig = "true";
  scriptEl.textContent = JSON.stringify(config);
  document.head.appendChild(scriptEl);
</script>
