---
import fs from "fs";
import path from "path";

// Get current path for highlighting active links
const pathname = new URL(Astro.request.url).pathname;
const currentPath: string[] = pathname.replace(".html", "").split("/");

// Get the absolute path to the files directory
const filesPath = path.join(process.cwd(), import.meta.env.FILES_DIR);

function isDirectory(source: string): boolean {
  return fs.lstatSync(source).isDirectory();
}

// Read directories in the files path to get subjects
const validSubjects = fs
  .readdirSync(filesPath)
  .filter((file) => isDirectory(path.join(filesPath, file)));

// Define the navStructure type to avoid TypeScript errors
interface NavStructure {
  [key: string]: string[];
}

// Generate navigation structure dynamically
const navStructure: NavStructure = {};

validSubjects.forEach((subject) => {
  let subjectPath;

  if (subject === "admitere") {
    subjectPath = path.join(filesPath, subject);
  } else {
    subjectPath = path.join(filesPath, `${subject}/pages`);
  }

  // Read subdirectories to get pages
  const subPages = fs.readdirSync(subjectPath).filter((file) => {
    const filePath = path.join(subjectPath, file);
    return isDirectory(filePath);
  });

  navStructure[subject] = subPages;
});

// // Ensure 'info' is in the navStructure even if not present in the filesystem
// if (!navStructure.info) {
//   navStructure.info = [];
// }
// // Ensure 'romana' is in the navStructure even if not present in the filesystem
// if (!navStructure.romana) {
//   navStructure.romana = [];
// }

navStructure.notite = ["info", "romana"];

const navEntries = Object.entries(navStructure);

// Define the desired order of subjects
// const subjectOrder = ["fizica", "mate", "info", "romana", "admitere"];

// Helper function to get display name for navigation items
function getDisplayName(name: string): string {
  switch (name) {
    case "admitere":
      return "Admitere";
    
    case "romana":
      return "Română";
    
    case "mate":
      return "Matematică";
    case "istorie":
      return "Istorie";
    
    case "anat":
      return "Anatomie";
    case "bio":
      return "Biologie";
    case "chimie":
      return "Chimie";
    case "economie":
      return "Economie";
    case "filosofie":
      return "Filosofie";
    case "fizica":
      return "Fizică";
    case "geo":
      return "Geografie";
    case "info":
      return "Informatică";
    case "logica":
      return "Logică";
    case "psihologie":
      return "Psihologie";
    case "sociologie":
      return "Sociologie";
    
    case "simulari-judetene":
      return "Simulări județene/locale";
    
    default:
      return name.charAt(0).toUpperCase() + name.replace(/-/g, " ").slice(1);
  }
}

// Helper function to get the URL for a nav item
function getNavUrl(subject: string, page: string | null): string {
  if (subject === "fizica" && !page) return "/";
  if (!page) return `/${subject}`;
  return `/${subject}/${page}`;
}

// Helper function to determine if a nav link is active
function isActive(subject: string, page: string | null): boolean {
  // Special case for home page
  if (
    subject === "fizica" &&
    !page &&
    (currentPath[1] === "" || currentPath[1] === "index")
  ) {
    return true;
  }

  // Check if we're on the subject's section with the exact page
  if (currentPath[1] === subject) {
    // For main subject links with no specific page
    if (!page && !currentPath[2]) return true;

    // For specific page links - only highlight the exact match
    if (page && currentPath[2] === page) return true;
  }

  return false;
}

// Helper function to check if a subject item should be highlighted (for dropdowns)
function isSubjectActive(subject: string): boolean {
  // Special case for home page - treat as 'fizica'
  if (
    (currentPath[1] === "" || currentPath[1] === "index") &&
    subject === "fizica"
  ) {
    return true;
  }
  return currentPath[1] === subject;
}

// Determine which subjects should have dropdown menus
function shouldHaveDropdown(subject: string): boolean {
  // Only show dropdown if the subject has more than one page
  return navStructure[subject] && navStructure[subject].length > 1;
}
---

<>
  <div class="nav-wrapper">
    <aside class="nav-rail hidden lg:flex" aria-label="Navigare materii">
      <div class="brand-block">
        <a
          class="brand-link"
          href="https://github.com/DynoW/cuza.pages.dev"
          aria-label="Pagina de GitHub"
        >
          <img
            src="/assets/img/logo/atom-w.svg"
            width="32"
            height="35"
            alt="logo"
            class="brand-logo"
          />
          <div class="brand-text">
            <p id="page-title" class="brand-name">Cuza.Pages.dev</p>
            <p class="brand-sub">
              Subiecte de bac și admitere pentru liceeni și profesori.
            </p>
          </div>
        </a>
      </div>
      <nav class="nav-scroll">
        <ul class="nav-list" data-nav-list data-variant="desktop">
          {
            navEntries.map(([subject, pages]: [string, string[]]) => {
              const variant = "desktop";
              const dropdownId = `${variant}-dropdown-${subject}`;

              return (
                <li
                  class="nav-item"
                  data-has-dropdown={shouldHaveDropdown(subject)}
                >
                  {shouldHaveDropdown(subject) ? (
                    <>
                      <button
                        type="button"
                        class={
                          isSubjectActive(subject)
                            ? "nav-link active"
                            : "nav-link"
                        }
                        aria-expanded={isSubjectActive(subject)}
                        aria-controls={dropdownId}
                        data-nav-trigger
                        data-subject={subject}
                      >
                        <span>{getDisplayName(subject)}</span>
                        <span class="chevron">&gt;</span>
                      </button>
                      <div
                        class="dropdown-panel"
                        id={dropdownId}
                        data-dropdown={subject}
                      >
                        {subject === "fizica" && (
                          <a
                            class={
                              isActive(subject, null)
                                ? "dropdown-link active"
                                : "dropdown-link"
                            }
                            href="/"
                            data-nav-link
                          >
                            Bac
                          </a>
                        )}
                        {pages
                          .filter(
                            (page: string) =>
                              !(subject === "fizica" && page === "bac")
                          )
                          .map((page: string) => (
                            <a
                              class={
                                isActive(subject, page)
                                  ? "dropdown-link active"
                                  : "dropdown-link"
                              }
                              href={getNavUrl(subject, page)}
                              data-nav-link
                            >
                              {getDisplayName(page)}
                            </a>
                          ))}
                      </div>
                    </>
                  ) : (
                    <a
                      class={
                        isActive(subject, pages[0])
                          ? "nav-link active"
                          : "nav-link"
                      }
                      href={getNavUrl(subject, pages[0])}
                      data-nav-link
                    >
                      <span>{getDisplayName(subject)}</span>
                    </a>
                  )}
                </li>
              );
            })
          }
        </ul>
      </nav>
    </aside>

    <div class="mobile-topbar lg:hidden">
      <div class="brand-inline">
        <img
          src="/assets/img/logo/atom-w.svg"
          width="26"
          height="28"
          alt="logo"
        />
        <div>
          <p class="brand-inline-name">Cuza.Pages.dev</p>
          <p class="brand-inline-sub">Bac și admitere</p>
        </div>
      </div>
      <button
        id="mobile-menu-button"
        aria-label="Deschide meniul"
        class="hamburger"
        type="button"
      >
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>

    <div id="mobile-overlay" class="mobile-overlay" aria-hidden="true"></div>
    <div id="mobile-drawer" class="mobile-drawer" aria-hidden="true">
      <div class="drawer-header">
        <div class="brand-inline">
          <img
            src="/assets/img/logo/atom-w.svg"
            width="26"
            height="28"
            alt="logo"
          />
          <div>
            <p class="brand-inline-name">Cuza.Pages.dev</p>
            <p class="brand-inline-sub">Navigare rapidă</p>
          </div>
        </div>
        <button
          id="mobile-close-button"
          aria-label="Închide meniul"
          class="close-button"
          type="button"
        >
          ✕
        </button>
      </div>
      <nav>
        <ul class="nav-list" data-nav-list data-variant="mobile">
          {
            navEntries.map(([subject, pages]: [string, string[]]) => {
              const variant = "mobile";
              const dropdownId = `${variant}-dropdown-${subject}`;

              return (
                <li
                  class="nav-item"
                  data-has-dropdown={shouldHaveDropdown(subject)}
                >
                  {shouldHaveDropdown(subject) ? (
                    <>
                      <button
                        type="button"
                        class={
                          isSubjectActive(subject)
                            ? "nav-link active"
                            : "nav-link"
                        }
                        aria-expanded={isSubjectActive(subject)}
                        aria-controls={dropdownId}
                        data-nav-trigger
                        data-subject={subject}
                      >
                        <span>{getDisplayName(subject)}</span>
                        <span class="chevron">&gt;</span>
                      </button>
                      <div
                        class="dropdown-panel"
                        id={dropdownId}
                        data-dropdown={subject}
                      >
                        {subject === "fizica" && (
                          <a
                            class={
                              isActive(subject, null)
                                ? "dropdown-link active"
                                : "dropdown-link"
                            }
                            href="/"
                            data-nav-link
                          >
                            Bac
                          </a>
                        )}
                        {pages
                          .filter(
                            (page: string) =>
                              !(subject === "fizica" && page === "bac")
                          )
                          .map((page: string) => (
                            <a
                              class={
                                isActive(subject, page)
                                  ? "dropdown-link active"
                                  : "dropdown-link"
                              }
                              href={getNavUrl(subject, page)}
                              data-nav-link
                            >
                              {getDisplayName(page)}
                            </a>
                          ))}
                      </div>
                    </>
                  ) : (
                    <a
                      class={
                        isActive(subject, pages[0])
                          ? "nav-link active"
                          : "nav-link"
                      }
                      href={getNavUrl(subject, pages[0])}
                      data-nav-link
                    >
                      <span>{getDisplayName(subject)}</span>
                    </a>
                  )}
                </li>
              );
            })
          }
        </ul>
      </nav>
    </div>

    <header class="page-hero">
      <div class="hero-inner container max-w-(--breakpoint-lg) mx-auto flex flex-col gap-4 md:flex-row md:items-center">
        <div class="hero-copy">
          <p class="eyebrow">cuza.pages.dev</p>
          <h1 class="hero-title">
            Subiecte de bac din anii anteriori la fizică și matematică.
          </h1>
          <p class="hero-sub">
            Materiale create de elevi pentru elevi și profesori. Simulări, modele și notițe la un click distanță.
          </p>
        </div>
        <div class="hero-banner">
          <img
            alt="banner"
            src="/assets/img/banner/fizica.webp"
            class="hero-banner-img"
            height="160"
            width="800"
          />
        </div>
      </div>
    </header>
  </div>

  <style>
    :global(body) {
      --sidebar-width: 252px;
    }

    @media (min-width: 1024px) {
      :global(body) {
        padding-left: var(--sidebar-width);
      }
    }

    .nav-wrapper {
      position: relative;
    }

    .nav-rail {
      position: fixed;
      inset: 0 auto 0 0;
      width: var(--sidebar-width);
      background: rgba(10, 13, 16, 0.96);
      backdrop-filter: blur(8px);
      border-right: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1.25rem 1rem 1.5rem;
      z-index: 60;
      overflow-y: auto;
      overflow-x: visible;
    }

    .brand-block {
      padding: 0.5rem 0.25rem 0.75rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      margin-bottom: 0.25rem;
    }

    .brand-link {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      text-decoration: none;
      color: #e5edff;
    }

    .brand-logo {
      flex-shrink: 0;
    }

    .brand-text {
      display: flex;
      flex-direction: column;
      gap: 0.15rem;
    }

    .brand-name {
      font-weight: 800;
      font-size: 1.1rem;
      margin: 0;
      line-height: 1.1;
    }

    .brand-sub {
      margin: 0;
      font-size: 0.85rem;
      color: #a7b7d9;
      line-height: 1.3;
    }

    .nav-scroll {
      padding-right: 0.4rem;
    }

    .nav-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }

    .nav-item {
      position: relative;
    }

    .nav-link {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
      padding: 0.65rem 0.9rem;
      border-radius: 0.85rem;
      background: transparent;
      color: #9fb7ff;
      font-weight: 700;
      text-decoration: none;
      border: none;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
      text-align: left;
    }

    .nav-link:hover,
    .nav-link:focus-visible {
      background: rgba(255, 255, 255, 0.08);
      color: #d6f87a;
      outline: none;
      transform: translateX(2px);
    }

    .nav-link.active {
      background: rgba(255, 255, 255, 0.12);
      color: #d6f87a;
    }

    .chevron {
      font-size: 0.95rem;
      opacity: 0.8;
    }

    .dropdown-panel {
      position: absolute;
      left: calc(100% + 10px);
      top: 0;
      display: none;
      flex-direction: column;
      gap: 0.2rem;
      min-width: 220px;
      padding: 0.5rem;
      background: rgba(10, 13, 16, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 0.85rem;
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.35);
      z-index: 65;
    }

    .dropdown-link {
      display: block;
      padding: 0.55rem 0.75rem;
      border-radius: 0.7rem;
      color: #dce5ff;
      text-decoration: none;
      font-weight: 700;
      transition: background 0.2s ease, color 0.2s ease;
    }

    .dropdown-link:hover,
    .dropdown-link:focus-visible {
      background: rgba(255, 255, 255, 0.06);
      color: #d6f87a;
      outline: none;
    }

    .dropdown-link.active {
      color: #d6f87a;
      background: rgba(255, 255, 255, 0.08);
    }

    @media (hover: hover) and (min-width: 1024px) {
      .nav-item:hover .dropdown-panel,
      .nav-item:focus-within .dropdown-panel,
      .dropdown-panel.open {
        display: flex;
      }
    }

    @media (max-width: 1023px) {
      .dropdown-panel {
        position: static;
        left: auto;
        top: auto;
        display: none;
        border: none;
        background: transparent;
        box-shadow: none;
        padding: 0.25rem 0 0.25rem 0.85rem;
      }

      .dropdown-panel.open {
        display: flex;
      }
    }

    .mobile-topbar {
      position: sticky;
      top: 0;
      z-index: 55;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.9rem 1rem;
      background: rgba(10, 13, 16, 0.95);
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(6px);
      margin-bottom: 0.75rem;
    }

    .brand-inline {
      display: flex;
      align-items: center;
      gap: 0.6rem;
      color: #e6edff;
    }

    .brand-inline-name {
      font-weight: 800;
      margin: 0;
      line-height: 1.1;
    }

    .brand-inline-sub {
      margin: 0;
      font-size: 0.82rem;
      color: #9bb0d6;
    }

    .hamburger {
      display: inline-flex;
      flex-direction: column;
      justify-content: center;
      gap: 6px;
      padding: 0.35rem 0.25rem;
      border: 1px solid rgba(255, 255, 255, 0.18);
      border-radius: 0.75rem;
      background: rgba(255, 255, 255, 0.06);
      cursor: pointer;
      width: 48px;
      height: 46px;
      transition: transform 0.2s ease;
    }

    .hamburger span {
      display: block;
      height: 2px;
      width: 100%;
      background: #e6edff;
      border-radius: 9999px;
    }

    .hamburger:hover {
      transform: scale(1.03);
    }

    .mobile-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 62;
    }

    .mobile-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .mobile-drawer {
      position: fixed;
      inset: 0 auto 0 0;
      width: 82%;
      max-width: 340px;
      background: rgba(10, 13, 16, 0.98);
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      transform: translateX(-100%);
      transition: transform 0.25s ease;
      z-index: 70;
      padding: 1rem 1rem 1.25rem;
      overflow-y: auto;
    }

    .mobile-drawer.open {
      transform: translateX(0);
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .close-button {
      border: 1px solid rgba(255, 255, 255, 0.18);
      background: rgba(255, 255, 255, 0.06);
      color: #e6edff;
      border-radius: 0.75rem;
      width: 44px;
      height: 44px;
      font-size: 1.1rem;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    .close-button:hover,
    .close-button:focus-visible {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
      outline: none;
    }

    .page-hero {
      padding: 0 1rem;
      margin-bottom: 1rem;
    }

    .hero-inner {
      background: rgba(10, 13, 16, 0.9);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 1.5rem;
      padding: 1.25rem;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.25);
    }

    .hero-copy {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      color: #e6edff;
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.75rem;
      color: #9bb0d6;
      margin: 0;
    }

    .hero-title {
      margin: 0;
      font-size: clamp(1.35rem, 3vw, 1.8rem);
      line-height: 1.25;
      font-weight: 800;
    }

    .hero-sub {
      margin: 0;
      font-size: 1rem;
      color: #c8d6f4;
      line-height: 1.5;
    }

    .hero-banner {
      width: 100%;
      max-width: 420px;
      margin-left: auto;
    }

    .hero-banner-img {
      width: 100%;
      height: 140px;
      object-fit: cover;
      border-radius: 1.1rem;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 16px 32px rgba(0, 0, 0, 0.25);
    }
  </style>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const drawer = document.getElementById("mobile-drawer");
      const overlay = document.getElementById("mobile-overlay");
      const openButton = document.getElementById("mobile-menu-button");
      const closeButton = document.getElementById("mobile-close-button");

      const toggleDrawer = (open) => {
        if (!drawer || !overlay) return;
        drawer.classList.toggle("open", open);
        overlay.classList.toggle("open", open);
        drawer.setAttribute("aria-hidden", open ? "false" : "true");
        document.body.classList.toggle("overflow-hidden", open);
      };

      openButton?.addEventListener("click", () => toggleDrawer(true));
      closeButton?.addEventListener("click", () => toggleDrawer(false));
      overlay?.addEventListener("click", () => toggleDrawer(false));

      const closeSiblings = (list, currentId) => {
        list.querySelectorAll(".dropdown-panel.open").forEach((panel) => {
          if (panel.id !== currentId) {
            panel.classList.remove("open");
            const trigger = list.querySelector(
              `[aria-controls="${panel.id}"]`
            );
            trigger?.setAttribute("aria-expanded", "false");
          }
        });
      };

      const navLists = document.querySelectorAll("[data-nav-list]");
      navLists.forEach((list) => {
        const variant = list.getAttribute("data-variant");

        const toggleDropdown = (trigger, dropdownId, force) => {
          const dropdown = document.getElementById(dropdownId);
          if (!dropdown) return;

          const isHoverDesktop =
            variant === "desktop" && window.matchMedia("(hover: hover)").matches;
          const shouldToggle = force || variant === "mobile" || !isHoverDesktop;

          if (shouldToggle) {
            const willOpen = !dropdown.classList.contains("open");
            closeSiblings(list, dropdownId);
            dropdown.classList.toggle("open", willOpen);
            trigger.setAttribute("aria-expanded", willOpen ? "true" : "false");
          }
        };

        list.querySelectorAll("[data-nav-trigger]").forEach((trigger) => {
          trigger.addEventListener("click", (event) => {
            event.preventDefault();
            const dropdownId = trigger.getAttribute("aria-controls");
            if (!dropdownId) return;
            toggleDropdown(trigger, dropdownId, false);
          });

          trigger.addEventListener("keydown", (event) => {
            if (event.key === "Enter" || event.key === " ") {
              event.preventDefault();
              const dropdownId = trigger.getAttribute("aria-controls");
              if (!dropdownId) return;
              toggleDropdown(trigger, dropdownId, true);
            }
            if (event.key === "Escape") {
              const dropdownId = trigger.getAttribute("aria-controls");
              if (!dropdownId) return;
              const dropdown = document.getElementById(dropdownId);
              dropdown?.classList.remove("open");
              trigger.setAttribute("aria-expanded", "false");
            }
          });
        });

        list.querySelectorAll("[data-nav-link]").forEach((link) => {
          link.addEventListener("click", () => {
            if (variant === "mobile") toggleDrawer(false);
          });
        });
      });

      const month = new Date().getMonth();
      if (month === 11) {
        const logoContainer = document.getElementById("page-title");
        if (logoContainer && !logoContainer.querySelector("img[data-hat]")) {
          const img = document.createElement("img");
          img.src = "/assets/img/logo/sapca.png";
          img.width = 32;
          img.height = 35;
          img.alt = "sapca";
          img.dataset.hat = "true";
          img.style.position = "relative";
          img.style.marginRight = "6px";
          logoContainer.prepend(img);
        }
      }
    });
  </script>
</>
